<!doctype html>
<html>
<head><meta charset="utf-8"><title>Painel</title><link rel="stylesheet" href="/styles.css"></head>
<body>
<div class="container">
  <div class="header"><div class="logo">SC</div><div><h2 style="margin:0">Painel</h2><div class="small">Minhas Câmeras</div></div></div>
  <div class="card" style="margin-top:12px">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="newDevice" class="input" placeholder="Novo device id (ex: CAM001)"/>
      <button id="addBtn" class="btn">Adicionar</button>
      <button id="logout" class="btn" style="background:#7c3aed">Logout</button>
      <button id="viewSel" class="btn" style="margin-left:auto">Ver Seleccionadas</button>
    </div>
    <div id="grid" class="grid" style="margin-top:12px"></div>
  </div>
  <div class="footer">Selecciona câmeras e clic Em "Ver Seleccionadas"</div>
</div>

<script>
(function(){
  // Tenta obter token: primeiro localStorage, depois cookie stealth_token
  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'));
    return m ? decodeURIComponent(m[2]) : null;
  }

  var token = localStorage.getItem('token');
  if (!token) {
    var c = getCookie('stealth_token');
    if (c) {
      try { localStorage.setItem('token', c); token = c; }
      catch(e) { console.warn('could not set localStorage token', e); }
    }
  }

  if (!token) {
    // Nenhum token: redireciona para login
    return location.href = '/login.html';
  }

  const $ = id => document.getElementById(id);
  const grid = $('grid'), addBtn = $('addBtn'), newDevice = $('newDevice'), logout = $('logout'), viewSel = $('viewSel');

  logout.addEventListener('click', ()=>{ localStorage.removeItem('token'); document.cookie = 'stealth_token=; Max-Age=0; path=/'; location.href='/login.html' });

  addBtn.addEventListener('click', async ()=>{
    const id = newDevice.value.trim();
    if(!id) return alert('preenche device id');
    const res = await fetch('/api/device/add', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':'Bearer ' + token }, body: JSON.stringify({ deviceId: id, label: '' })});
    const j = await res.json().catch(()=>null);
    if(!res.ok) return alert('Erro: ' + (j && j.error));
    newDevice.value = ''; load();
  });

  viewSel.addEventListener('click', ()=>{
    const checked = Array.from(grid.querySelectorAll('input[type=checkbox]:checked')).map(ch => ch.value);
    if(checked.length === 0) return alert('Selecciona ao menos 1 camera');
    const url = '/viewer_multi.html?devices=' + encodeURIComponent(checked.join(','));
    window.open(url, '_blank');
  });

  async function load(){
    const res = await fetch('/api/devices', { headers: { 'Authorization': 'Bearer ' + token }});
    if(!res.ok) { alert('Erro a carregar devices'); return; }
    const j = await res.json();
    grid.innerHTML = '';
    for(const d of j.devices){
      const div = document.createElement('div'); div.className = 'card';
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = d.deviceId;
      const h = document.createElement('h4'); h.textContent = d.deviceId + (d.label ? ' - ' + d.label : '');
      const img = document.createElement('img'); img.className = 'thumb'; img.src = '/stream/' + encodeURIComponent(d.deviceId);
      const meta = document.createElement('div'); meta.className = 'small'; meta.textContent = 'online: ' + d.online + ' | ' + new Date(d.lastSeen).toLocaleString();
      div.appendChild(chk); div.appendChild(h); div.appendChild(img); div.appendChild(meta);
      grid.appendChild(div);
      img.addEventListener('click', ()=> window.open('/viewer.html?device=' + encodeURIComponent(d.deviceId), '_blank'));
    }
  }

  load();
})();
</script>

</html>
