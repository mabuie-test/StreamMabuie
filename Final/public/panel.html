<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>StealthCam — Painel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SC</div>
      <div>
        <h2 style="margin:0">Painel</h2>
        <div class="small">Minhas Câmeras</div>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div style="display:flex;gap:8px;align-items:center">
        <input id="newDevice" class="input" placeholder="Novo device id (ex: CAM001)" style="max-width:240px"/>
        <button id="addBtn" class="btn">Adicionar</button>
        <button id="logout" class="btn" style="background:#7c3aed">Logout</button>
      </div>

      <div id="grid" class="grid" style="margin-top:12px"></div>
    </div>

    <div class="footer">Clique na miniatura para abrir o viewer (WS)</div>
  </div>

  <script>
  (async function(){
    const token = localStorage.getItem('token');
    if(!token) return location.href = '/login.html';
    const $ = id => document.getElementById(id);
    const grid = $('grid'), addBtn = $('addBtn'), newDevice = $('newDevice'), logout = $('logout');

    logout.addEventListener('click', ()=>{ localStorage.removeItem('token'); location.href='/login.html' });

    async function load(){
      const res = await fetch('/api/devices', { headers: { 'Authorization': 'Bearer ' + token }});
      const j = await res.json().catch(()=>null);
      if(!res.ok){ alert('Erro: ' + (j && j.error)); return; }
      grid.innerHTML = '';
      for(const d of j.devices){
        const div = document.createElement('div'); div.className='card';
        const h = document.createElement('h4'); h.textContent = d.deviceId + (d.label? ' - '+d.label : '');
        const img = document.createElement('img'); img.className='thumb';
        img.src = '/stream/' + encodeURIComponent(d.deviceId);
        img.addEventListener('click', ()=> openViewer(d.deviceId));
        const meta = document.createElement('div'); meta.className='small'; meta.textContent = 'online: ' + d.online + ' | ' + new Date(d.lastSeen).toLocaleString();
        div.appendChild(h); div.appendChild(img); div.appendChild(meta); grid.appendChild(div);
      }
    }

    function openViewer(id){
      const url = '/viewer.html?device=' + encodeURIComponent(id);
      window.open(url, '_blank');
    }

    addBtn.addEventListener('click', async ()=>{
      const id = newDevice.value.trim();
      if(!id) return alert('preenche device id');
      // create device record owned by user
      const res = await fetch('/api/device/add', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ deviceId: id, label: '' })});
      const j = await res.json().catch(()=>null);
      if(!res.ok) return alert('Erro: ' + (j && j.error));
      newDevice.value = ''; load();
    });

    await load();
  })();
  </script>
</body>
</html>
