<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>StealthCam — Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">SC</div>
      <div>
        <h2 style="margin:0">StealthCam</h2>
        <div class="small">Acesso ao painel</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;max-width:420px">
      <label class="small">Username</label>
      <input id="user" class="input" placeholder="username" autocomplete="username" />
      <label class="small" style="margin-top:8px">Password</label>
      <input id="pass" type="password" class="input" placeholder="password" autocomplete="current-password" />
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btn" class="btn">Login</button>
        <button id="btnDemo" class="btn" style="background:#7c3aed">Criar demo</button>
      </div>
      <div id="msg" class="small" style="margin-top:8px;color:#f88"></div>
    </div>

    <div class="footer">Feito para funcionar com a app Android — endpoints: /api/auth, /api/frame/:deviceId, /ws, /stream/:deviceId</div>
  </div>

  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const btn = $('btn'), btnDemo = $('btnDemo'), msg = $('msg');
    async function doLogin(){
      try {
        btn.disabled = true; msg.innerText = 'A tentar iniciar sessão...';
        const username = $('user').value.trim(), password = $('pass').value.trim();
        if(!username||!password){ msg.innerText='Preenche campos'; btn.disabled=false; return; }
        const res = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password })});
        const j = await res.json().catch(()=>null);
        if(!res.ok) { msg.innerText = (j && j.error) || 'Login falhou'; btn.disabled=false; return; }
        localStorage.setItem('token', j.token);
        window.location.href = '/panel.html';
      } catch(e){ console.error(e); msg.innerText = 'Erro rede: ' + e.message; btn.disabled=false; }
    }
    async function createDemo(){
      btnDemo.disabled = true; msg.innerText = 'Criando demo...';
      try {
        const u = 'demo' + Math.floor(Math.random()*10000);
        const r = await fetch('/api/auth/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:'demo1234' })});
        const j = await r.json().catch(()=>null);
        if(!r.ok){ msg.innerText = (j && j.error) || 'Erro'; return; }
        $('user').value = u; $('pass').value = 'demo1234'; msg.innerText = 'Demo criado. Faz login.';
      } catch(e){ msg.innerText = e.message; } finally { btnDemo.disabled=false; }
    }
    btn.addEventListener('click', doLogin);
    btnDemo.addEventListener('click', createDemo);
  })();
  </script>
</body>
</html>
