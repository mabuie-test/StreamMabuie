<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
  <style>.viewerWrap{display:flex;flex-direction:column;gap:8px;align-items:center}</style>
</head>
<body>
  <div class="container">
    <div class="card viewerWrap">
      <h3 id="title">Viewer</h3>
      <img id="img" style="max-width:860px;width:100%;height:auto;border-radius:8px;border:1px solid rgba(255,255,255,0.03)"/>
      <div style="display:flex;gap:8px">
        <button id="btnWS" class="btn">Connect WS</button>
        <button id="btnMJPEG" class="btn" style="background:#7c3aed">Open MJPEG</button>
      </div>
      <div id="status" class="small"></div>
    </div>
  </div>

  <script>
  (function(){
    const params = new URLSearchParams(location.search);
    const device = params.get('device');
    if(!device) { document.getElementById('title').innerText = 'No device'; return; }
    document.getElementById('title').innerText = 'Viewer â€” ' + device;
    const img = document.getElementById('img'), status = document.getElementById('status');
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    let ws;
    document.getElementById('btnWS').addEventListener('click', ()=>{
      try {
        status.innerText = 'Connecting WS...';
        ws = new WebSocket(proto + '://' + location.host + '/ws?viewerFor=' + encodeURIComponent(device));
        ws.binaryType = 'arraybuffer';
        ws.onopen = ()=> status.innerText = 'WS connected';
        ws.onclose = ()=> status.innerText = 'WS closed';
        ws.onerror = (e)=> status.innerText = 'WS error';
        ws.onmessage = ev => {
          const blob = new Blob([ev.data], {type:'image/jpeg'});
          const url = URL.createObjectURL(blob);
          img.src = url;
          setTimeout(()=> URL.revokeObjectURL(url), 600);
        };
      } catch(e){ status.innerText = 'err: ' + e.message; }
    });
    document.getElementById('btnMJPEG').addEventListener('click', ()=> {
      img.src = '/stream/' + encodeURIComponent(device);
      status.innerText = 'MJPEG open';
    });
  })();
  </script>
</body>
</html>
